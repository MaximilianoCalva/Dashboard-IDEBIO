<!-- 
    INSTRUCTIONS:
    1. Drag an HTML Widget into Elementor.
    2. Paste this code.
    3. REPLACE 'YOUR_N8N_WEBHOOK_URL' with the actual Production URL from your n8n Webhook node.
-->

<!-- Tailwind (Scoped or ensure global load) -->
<script src="https://cdn.tailwindcss.com"></script>

<div id="idebio-orders-widget" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-800">Historial de Pagos</h2>
        <button onclick="fetchIdebioOrders()"
            class="text-sm font-bold text-[#233878] hover:underline flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refrescar
        </button>
    </div>

    <!-- Loading State -->
    <div id="idebio-orders-loading" class="py-10 text-center">
        <div class="inline-block w-8 h-8 border-4 border-blue-100 border-t-[#233878] rounded-full animate-spin mb-2">
        </div>
        <p class="text-sm text-gray-400">Cargando pagos...</p>
    </div>

    <!-- Error State -->
    <div id="idebio-orders-error" class="hidden py-6 text-center text-red-500 bg-red-50 rounded-lg">
        <p class="text-sm font-bold">Error al cargar datos</p>
        <p class="text-xs opacity-80 mt-1">Verifica la conexión con n8n.</p>
    </div>

    <!-- Statistics Cards -->
    <div id="idebio-stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <!-- Card 1: Pagos Hoy -->
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
            <p class="text-xs text-blue-500 font-bold uppercase tracking-wider">Pagos Hoy</p>
            <p id="stats-count-today" class="text-2xl font-bold text-blue-900 mt-1">0</p>
        </div>
        <!-- Card 2: Monto Hoy -->
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
            <p class="text-xs text-blue-500 font-bold uppercase tracking-wider">Monto Hoy</p>
            <p id="stats-amount-today" class="text-2xl font-bold text-blue-900 mt-1">$0.00</p>
        </div>
        <!-- Card 3: Pagos 7 Días -->
        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
            <p class="text-xs text-indigo-500 font-bold uppercase tracking-wider">Pagos (7 Días)</p>
            <p id="stats-count-week" class="text-2xl font-bold text-indigo-900 mt-1">0</p>
        </div>
        <!-- Card 4: Monto 7 Días -->
        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
            <p class="text-xs text-indigo-500 font-bold uppercase tracking-wider">Monto (7 Días)</p>
            <p id="stats-amount-week" class="text-2xl font-bold text-indigo-900 mt-1">$0.00</p>
        </div>
    </div>

    <!-- Table -->
    <div id="idebio-orders-table" class="hidden overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead class="bg-gray-50 text-gray-500 uppercase font-bold text-xs">
                <tr>
                    <th class="px-4 py-3 rounded-l-lg">ID</th>
                    <th class="px-4 py-3">Fecha</th>
                    <th class="px-4 py-3">Concepto</th>
                    <th class="px-4 py-3">Email</th>
                    <th class="px-4 py-3">Monto</th>
                    <th class="px-4 py-3 rounded-r-lg">Estado</th>
                </tr>
            </thead>
            <tbody id="idebio-orders-body" class="divide-y divide-gray-50">
                <!-- Rows injected via JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // CONFIGURATION
    const N8N_WEBHOOK_URL = 'https://n8n.srv1017270.hstgr.cloud/webhook/get-payments'; // <--- PASTE YOUR URL HERE

    async function fetchIdebioOrders() {
        const loading = document.getElementById('idebio-orders-loading');
        const table = document.getElementById('idebio-orders-table');
        const errorDiv = document.getElementById('idebio-orders-error');
        const tbody = document.getElementById('idebio-orders-body');
        const statsContainer = document.getElementById('idebio-stats-container');

        // Reset UI
        loading.classList.remove('hidden');
        table.classList.add('hidden');
        statsContainer.classList.add('hidden');
        errorDiv.classList.add('hidden');
        tbody.innerHTML = '';

        try {
            const response = await fetch(N8N_WEBHOOK_URL);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

            let data = await response.json();

            // DEBUG: Log data to console
            console.log('n8n Response:', data);

            // Handle case where data is a single object (not array)
            if (data && !Array.isArray(data)) {
                // Check if it's an empty object (no results)
                if (Object.keys(data).length === 0) {
                    data = [];
                } else {
                    // Wrap single object in array
                    data = [data];
                }
            }

            if (!Array.isArray(data)) {
                throw new Error('La respuesta de n8n no es una lista válida. Recibido: ' + typeof data);
            }

            // --- CALCULATE STATISTICS ---
            let countToday = 0;
            let amountToday = 0;
            let countWeek = 0;
            let amountWeek = 0;

            const now = new Date();
            const todayStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(now.getDate() - 7);

            data.forEach(order => {
                const orderTotal = parseFloat(order.total || 0);
                const orderDateStr = order.date_created || '';

                if (orderDateStr) {
                    const orderDate = new Date(orderDateStr);
                    const orderDateYMD = orderDate.toISOString().split('T')[0];

                    // Check Today
                    if (orderDateYMD === todayStr) {
                        countToday++;
                        amountToday += orderTotal;
                    }

                    // Check Last 7 Days (Inclusive)
                    if (orderDate >= sevenDaysAgo && orderDate <= now) {
                        countWeek++;
                        amountWeek += orderTotal;
                    }
                }
            });

            // Update Stats UI
            document.getElementById('stats-count-today').textContent = countToday;
            document.getElementById('stats-amount-today').textContent = '$' + amountToday.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            document.getElementById('stats-count-week').textContent = countWeek;
            document.getElementById('stats-amount-week').textContent = '$' + amountWeek.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            statsContainer.classList.remove('hidden');

            // --- RENDER TABLE ---
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">No se encontraron pagos recientes.</td></tr>';
            } else {
                data.forEach(order => {
                    const row = document.createElement('tr');

                    // Safe access to properties
                    const dateStr = order.date_created || new Date().toISOString();
                    const dateObj = new Date(dateStr);
                    const formattedDate = dateObj.toLocaleDateString();

                    const paymentTitle = order.payment_method_title || 'N/A';
                    const email = order.email || 'N/A';
                    const total = order.total || '0.00';
                    const currency = order.currency || '';
                    const status = order.status || 'unknown';
                    const id = order.id || '---';

                    let statusColor = 'bg-gray-100 text-gray-600';
                    if (status === 'completed') statusColor = 'bg-green-100 text-green-700';
                    if (status === 'processing') statusColor = 'bg-blue-100 text-blue-700';
                    if (status === 'pending') statusColor = 'bg-yellow-100 text-yellow-700';
                    if (status === 'cancelled') statusColor = 'bg-red-100 text-red-700';
                    if (status === 'failed') statusColor = 'bg-red-100 text-red-700';

                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold text-gray-800">#${id}</td>
                        <td class="px-4 py-3 text-gray-500">${formattedDate}</td>
                        <td class="px-4 py-3 text-gray-600">${paymentTitle}</td>
                        <td class="px-4 py-3 text-gray-500 text-xs">${email}</td>
                        <td class="px-4 py-3 font-bold text-gray-800">$${total} ${currency}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusColor}">${status}</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            loading.classList.add('hidden');
            table.classList.remove('hidden');

        } catch (error) {
            console.error('Error fetching orders:', error);
            loading.classList.add('hidden');
            errorDiv.classList.remove('hidden');
            // Show detailed error
            errorDiv.innerHTML = `
                <p class="text-sm font-bold">Error al procesar datos</p>
                <p class="text-xs opacity-80 mt-1 mb-2">${error.message}</p>
                <details class="text-[10px] text-left bg-red-100 p-2 rounded cursor-pointer">
                    <summary>Ver Respuesta Técnica</summary>
                    <pre class="mt-1 overflow-x-auto whitespace-pre-wrap font-mono text-red-800">Check Console or see below if available</pre>
                </details>
            `;
        }
    }

    // Auto-load on snippet render if URL is set (and not the placeholder)
    if (N8N_WEBHOOK_URL !== 'YOUR_N8N_WEBHOOK_URL') {
        fetchIdebioOrders();
    } else {
        // Show placeholder state or just log warning
        console.warn('IDEBIO Widget: n8n Webhook URL not configured.');
        document.getElementById('idebio-orders-loading').innerHTML = '<p class="text-xs text-orange-500">Configura la URL del Webhook en el código.</p>';
    }
</script>